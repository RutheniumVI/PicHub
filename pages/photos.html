<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3" crossorigin="anonymous"></script>
<link rel="stylesheet" href="../css/photos.css">

<script>
    keyword = ''
    tags = {}
    enableTags = false
    images = JSON.parse(localStorage.getItem("images"))

    sortBy = "dateUploaded"
    sortOrder = "descending"

    function sortImages(){
        images.sort((a, b) => {
            if(sortBy === "dateTaken"){
                if(sortOrder === "ascending"){
                    return new Date(a.dateTaken) - new Date(b.dateTaken);
                } else {
                    return new Date(b.dateTaken) - new Date(a.dateTaken);
                }
            } else {
                if(sortOrder === "ascending"){
                    return new Date(a.dateUploaded) - new Date(b.dateUploaded);
                } else {
                    return new Date(b.dateUploaded) - new Date(a.dateUploaded);
                }
            }
        })
    }

    function renderImages(){
        sortImages();

        var photos = document.getElementById("photos");

        photos.innerHTML = '';

        var prevDate = null;
        var currGallery = null;
        images.forEach(img => {
            var displayImage = false;
            if (keyword.length > 0){
                if (img.tags.includes(keyword.toLowerCase())){
                    displayImage = true
                }

            }
            else if(enableTags){
                for(let i = 0; i < img.tags.length; i++){
                    if(tags[img.tags[i]]){
                        displayImage = true;
                        break;
                    }
                }
            } else {
                displayImage = true;
            }

            if(sortBy == "dateTaken"){
                sortDate = img.dateTaken;
            } else {
                sortDate = img.dateUploaded;
            }

            if(displayImage){
                if(prevDate == null || new Date(sortDate).getTime() != prevDate.getTime()){
                    prevDate = new Date(sortDate);

                    var dateText = document.createElement("p");
                    dateText.innerHTML = new Date(sortDate).toString().substring(4, 15);
                    photos.appendChild(dateText);

                    var line = document.createElement("hr");
                    photos.appendChild(line);


                    var container = document.createElement("div");
                    container.classList.add("container-fluid");
                    photos.appendChild(container);

                    currGallery = document.createElement("div");
                    currGallery.classList.add("row");
                    container.appendChild(currGallery);
                }

                var imgDiv = document.createElement("div");
                imgDiv.classList.add("imgDiv");
                imgDiv.style.backgroundImage = "url("+img.src+")";
                currGallery.appendChild(imgDiv);
            }
        });
    }

    function tagClick(tag){
        var button = event.target;
        if(tags[button.innerHTML]){
            tags[button.innerHTML] = false;
            button.classList.add("tagButton-disabled");
        } else {
            tags[button.innerHTML]= true;
            button.classList.remove("tagButton-disabled");
        }

        if(enableTags){
            disableTags = false;
            for(tag in tags){
                if(tags[tag]){
                    disableTags = true;
                }
            }

            if(!disableTags){
                enableTags = false;
            }
        } else {
            enableTags = true;
        }
        keyword = ''
    
        renderImages();
    }

    function getTags(){
        var tagMap = {};

        images.forEach(img => {
            img.tags.forEach(tag => {
                if(!(tag in tagMap)){
                    tagMap[tag] = 1;
                } else {
                    tagMap[tag] = tagMap[tag]+1;
                }

            })
        })

        var tagsArray = [];
        for(tag in tagMap){
            tagsArray.push([tag, tagMap[tag]]);
        }
        tagsArray.sort((a, b) => {
            return b[1] - a[1];
        })

        for(let i = 0; i < Math.min(tagsArray.length, 5); i++){
            tags[tagsArray[i][0]] = false;
        }
    }

    function renderTags(){
        getTags();

        var tagsDiv = document.getElementById("tags");

        for (var tag in tags) {
            var column = document.createElement("div");
            column.classList.add("col", "tagsCol");

            var button = document.createElement("button");
            button.innerHTML = tag;
            button.classList.add("tagButton", "tagButton-disabled");
            button.onclick = tagClick;
            column.appendChild(button);

            tagsDiv.appendChild(column);
        }
    }

    function updateSortBy(type){
        if(type !== sortBy){
            sortBy = type;

            var dropdown = document.getElementById("sortBySelector");
            if(sortBy === "dateTaken"){
                dropdown.innerHTML = "Sort By: Date Taken ";
            } else {
                dropdown.innerHTML = "Sort By: Date Uploaded ";
            }
        }

        renderImages();
    }

    function updateSortOrder(order){
        if(order !== sortOrder){
            sortOrder = order;

            var dropdown = document.getElementById("sortOrderSelector");
            if(sortOrder === "ascending"){
                dropdown.innerHTML = "Sort Order: Oldest First ↑ ";
            } else {
                dropdown.innerHTML = "Sort By: Newest First ↓ ";
            }
        }

        renderImages();
    }

    function submitSearch(event){
        event.preventDefault();
        keyword = document.querySelector('#search-bar').value
        renderImages()
    }

    window.onload = function(){
        renderTags();
        renderImages();
    }
</script>

<div class="photosPage">
    <div>
        <nav class="navbar sticky-top navbar-expand-lg" style="background-color: E6E6E6;">
            <div class="container-fluid">
              <a class="navbar-brand" href="./photos.html">
                <img src="../files/logo.png" height="35"/>
              </a>
              <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
              </button>
              <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                  <li class="nav-item"></li>
                    <form class="d-flex search-form" onsubmit="submitSearch(event)">
                        <input id="search-bar" name="search" class="form-control me-2" type="search" placeholder="Search photos or albums ..." aria-label="Search">
                        <button class="btn btn-outline-dark" type="submit">Search</button>
                    </form>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="./photos.html">Photos</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="#">Albums</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="#" onclick="showUploadModal()">
                      Upload
                      <img src="../files/upload.png" height="20"/>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="#">
                      Trash
                      <img src="../files/trash.png" height="20"/>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="#">
                      <img src="../files/settings.png" height="30"/>
                    </a>
                  </li>
                </ul>
              </div>
            </div>
        </nav>
      
        <!-- Upload Modal -->
        <div id="uploadModal" class="modal">
          <!-- Modal content -->
          <div class="modal-content">
      
              <div class="container-fluid" style="padding: 0;">
                  <div class="row justify-content-between">
                      <div class="col">
                          <div class="container-fluid">
                              <div class="row justify-content-start">
                                  <div class="col"><h1>Uploading </h1></div>
                                  <div class="col"><span class="close">&times;</span></div>
                              </div>
                          </div>
                      </div>
                  </div>
                  <hr class="mainDivider"/>
                  <div class="row gx-5">
                      <div class="col justify-content-center">
                          <div class="row preview-img">
                              <img id="previewImg" src="../files/upload_placeholder.jpg" alt="preview-img">
                              <input type="file" id="file-input" accept="image/*" hidden>
                          </div>
                          <div class="row imageEdit justify-content-center">
                              <div class="col imageButtons"><input type="image" id="crop" src="../files/crop.png"/></div>
                              <div class="col imageButtons"><input type="image" id="resize" src="../files/resize.png"/></div>
                          </div>
                      </div>
                      <div class="col justify-content-center">
                          <div class="container-fluid">
                              <form class="uploadForm">
                                  <label for="name"><h3>Name:</h3></label><br>
                                  <input type="text" id="name" name="name"><br>
                                  <label for="dateTaken"><h3>Date taken:</h3></label><br>
                                  <input type="date" id="date" name="dateTaken" value="2018-07-22"><br>
                              </form>
                              <div class="row">
                                <h3>Tags:</h3><br>
                                <div class="col"><input type="text" placeholder="tag" id="tagInput"/></div>
                                <div class="col"><button class="actionButtons" id="addTagBtn">Add</button></div>
                              </div>
                              <div class="container">
                                <div class="row newTags" id="newTags">
                                </div>
                              </div>
                              <div class="row">
                                <h3>Suggested:</h3><br>
                              </div>
                              <div class="container">
                                  <div id="suggestedTags" class="row no-gutters justify-content-start">
                                      <div class="col suggestedTags"><button class="suggestedTagButton">Mountain</button></div>
                                      <div class="col suggestedTags"><button class="suggestedTagButton">River</button></div>
                                      <div class="col suggestedTags"><button class="suggestedTagButton">Nature</button></div>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
                  <div class="row justify-content-end buttonsRow">
                      <!-- <div class="col buttons"><button class="actionButtons" id="skipButton">Skip</button></div> -->
                      <div class="col cropResize"><button class="actionButtons" id="confirmButton">Upload</button></div>
                      
                  </div>
              </div>
          </div>
      
        </div>
      </div>

    <div class="container-fluid" style="padding: 0;">
        <div class="row justify-content-between">
            <div class="col">
                <div class="container-fluid">
                    <div id="tags" class="row justify-content-start">
                        <div class="col tagsText"><h1>Popular Tags: </h1></div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="container-fluid">
                    <div class="row justify-content-end">
                        <div class="col dropdown">
                            <button id="sortOrderSelector" class="btn btn-dark dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Sort Order: Newest First ↓
                            </button>
                            <ul class="dropdown-menu">
                            <li><a class="dropdown-item" style="cursor: pointer;" onclick="updateSortOrder('descending')">Newest First ↓ </a></li>
                            <li><a class="dropdown-item" style="cursor: pointer;" onclick="updateSortOrder('ascending')">Oldest First ↑ </a></li>
                            </ul>
                        </div>
                        <div class="col dropdown">
                            <button id="sortBySelector" class="btn btn-dark dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Sort By: Date Uploaded
                            </button>
                            <ul class="dropdown-menu">
                            <li><a class="dropdown-item" style="cursor: pointer;" onclick="updateSortBy('dateUploaded')">Date Uploaded</a></li>
                            <li><a class="dropdown-item" style="cursor: pointer;" onclick="updateSortBy('dateTaken')">Date Taken</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <hr class="mainDivider"/>
    <div id="photos">
    </div>
</div>