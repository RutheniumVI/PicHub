<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3" crossorigin="anonymous"></script>
<link rel="stylesheet" href="../css/photos.css">

<script>
    keyword = new URLSearchParams(window.location.search).get('search')
    tags = {}
    enableTags = false
    images = JSON.parse(localStorage.getItem("images"))

    sortBy = "dateUploaded"
    sortOrder = "descending"

    function sortImages(){
        images.sort((a, b) => {
            if(sortBy === "dateTaken"){
                if(sortOrder === "ascending"){
                    return new Date(a.dateTaken) - new Date(b.dateTaken);
                } else {
                    return new Date(b.dateTaken) - new Date(a.dateTaken);
                }
            } else {
                if(sortOrder === "ascending"){
                    return new Date(a.dateUploaded) - new Date(b.dateUploaded);
                } else {
                    return new Date(b.dateUploaded) - new Date(a.dateUploaded);
                }
            }
        })
    }

    function renderImages(){
        sortImages();

        var photos = document.getElementById("photos");

        photos.innerHTML = '';

        var prevDate = null;
        var currGallery = null;
        images.forEach(img => {
            var displayImage = false;
            if (keyword && keyword.length > 0){
                if (img.tags.includes(keyword.toLowerCase())){
                    displayImage = true
                }

            }
            else if(enableTags){
                for(let i = 0; i < img.tags.length; i++){
                    if(tags[img.tags[i]]){
                        displayImage = true;
                        break;
                    }
                }
            } else {
                displayImage = true;
            }

            if(sortBy == "dateTaken"){
                sortDate = img.dateTaken;
            } else {
                sortDate = img.dateUploaded;
            }

            if(displayImage){
                if(prevDate == null || new Date(sortDate).getTime() != prevDate.getTime()){
                    prevDate = new Date(sortDate);

                    var dateText = document.createElement("p");
                    dateText.innerHTML = new Date(sortDate).toString().substring(4, 15);
                    photos.appendChild(dateText);

                    var line = document.createElement("hr");
                    photos.appendChild(line);


                    var container = document.createElement("div");
                    container.classList.add("container-fluid");
                    photos.appendChild(container);

                    currGallery = document.createElement("div");
                    currGallery.classList.add("row");
                    container.appendChild(currGallery);
                }

                var imgDiv = document.createElement("div");
                imgDiv.classList.add("imgDiv");
                imgDiv.style.backgroundImage = "url("+img.src+")";
                currGallery.appendChild(imgDiv);
            }
        });
    }

    function tagClick(tag){
        var button = event.target;
        if(tags[button.innerHTML]){
            tags[button.innerHTML] = false;
            button.classList.add("tagButton-disabled");
        } else {
            tags[button.innerHTML]= true;
            button.classList.remove("tagButton-disabled");
        }

        if(enableTags){
            disableTags = false;
            for(tag in tags){
                if(tags[tag]){
                    disableTags = true;
                }
            }

            if(!disableTags){
                enableTags = false;
            }
        } else {
            enableTags = true;
        }
        keyword = ''
    
        renderImages();
    }

    function getTags(){
        var tagMap = {};

        images.forEach(img => {
            img.tags.forEach(tag => {
                if(tag != ""){
                    if(!(tag in tagMap)){
                        tagMap[tag] = 1;
                    } else {
                        tagMap[tag] = tagMap[tag]+1;
                    }
                }
            })
        })

        var tagsArray = [];
        for(tag in tagMap){
            tagsArray.push([tag, tagMap[tag]]);
        }
        tagsArray.sort((a, b) => {
            return b[1] - a[1];
        })

        for(let i = 0; i < Math.min(tagsArray.length, 5); i++){
            tags[tagsArray[i][0]] = false;
        }
    }

    function renderTags(){
        getTags();

        var tagsDiv = document.getElementById("tags");

        for (var tag in tags) {
            var column = document.createElement("div");
            column.classList.add("col", "tagsCol");

            var button = document.createElement("button");
            button.innerHTML = tag;
            button.classList.add("tagButton", "tagButton-disabled");
            button.onclick = tagClick;
            column.appendChild(button);

            tagsDiv.appendChild(column);
        }
    }

    function updateSortBy(type){
        if(type !== sortBy){
            sortBy = type;

            var dropdown = document.getElementById("sortBySelector");
            if(sortBy === "dateTaken"){
                dropdown.innerHTML = "Sort By: Date Taken ";
            } else {
                dropdown.innerHTML = "Sort By: Date Uploaded ";
            }
        }

        renderImages();
    }

    function updateSortOrder(order){
        if(order !== sortOrder){
            sortOrder = order;

            var dropdown = document.getElementById("sortOrderSelector");
            if(sortOrder === "ascending"){
                dropdown.innerHTML = "Sort Order: Oldest First ↑ ";
            } else {
                dropdown.innerHTML = "Sort By: Newest First ↓ ";
            }
        }

        renderImages();
    }

    function submitSearch(event){
        event.preventDefault();
        keyword = document.querySelector('#search-bar').value
        renderImages()
    }

    window.onload = function(){
        renderTags();
        renderImages();
    }
</script>

<div class="photosPage">
    <div class="container-fluid" style="padding: 0;">
        <div class="row justify-content-between">
            <div class="col">
                <div class="container-fluid">
                    <div id="tags" class="row justify-content-start">
                        <div class="col tagsText"><h1>Popular Tags: </h1></div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="container-fluid">
                    <div class="row justify-content-end">
                        <div class="col dropdown">
                            <button id="sortOrderSelector" class="btn btn-dark dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Sort Order: Newest First ↓
                            </button>
                            <ul class="dropdown-menu">
                            <li><a class="dropdown-item" style="cursor: pointer;" onclick="updateSortOrder('descending')">Newest First ↓ </a></li>
                            <li><a class="dropdown-item" style="cursor: pointer;" onclick="updateSortOrder('ascending')">Oldest First ↑ </a></li>
                            </ul>
                        </div>
                        <div class="col dropdown">
                            <button id="sortBySelector" class="btn btn-dark dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Sort By: Date Uploaded
                            </button>
                            <ul class="dropdown-menu">
                            <li><a class="dropdown-item" style="cursor: pointer;" onclick="updateSortBy('dateUploaded')">Date Uploaded</a></li>
                            <li><a class="dropdown-item" style="cursor: pointer;" onclick="updateSortBy('dateTaken')">Date Taken</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <hr class="mainDivider"/>
    <div id="photos">
    </div>
</div>